# 开发流程（Quark-Media-System）

## 项目清理与目录结构（Project Manifesto）
- Project Manifesto/ 位于 Quark-Media-System 同级目录，作为核心交付目录。
- Project Manifesto/ 包含 frontend/、services/、docs/（保留原有结构）。
- Quark-Media-System/ 内的 frontend/ 与 services/ 已移除，仅保留在 Project Manifesto/。
- 已清理：.env*、docker-compose.yml、docker-daemon.json、*.log、test_quark_client.py、.trae/、data/、scripts/、references/、__pycache__/、*.pyc、*.tsbuildinfo、frontend/node_modules/、frontend/.next/、frontend/out/。
- 备注：.env.example 保留在 Project Manifesto/frontend/ 内。

## 项目概览
目标：实现“存链不存文”，解析夸克分享链接入库，用户触发时再转存到网盘并通过 WebDAV 提供访问。

核心服务：
- core-backend：FastAPI + SQLModel + Postgres + Redis
- worker：独立 Python 任务处理（转存）
- quarkdrive-webdav：Rust 服务，WebDAV 访问与缓存

数据流（高层）：
1) /api/v1/share/parse 解析分享 → 过滤视频/大文件 → 写入 VirtualMedia
2) /api/v1/media/{id}/provision 入队 Redis
3) worker 消费队列 → 夸克转存 → 刷新 WebDAV 缓存 → 更新 DB


## 已完成（开发进度）
### Phase 2（解析入库）
- Docker + Postgres 已集成，DATABASE_URL 生效。
- VirtualMedia 模型已存在并支持 virtual_path。
- /api/v1/share/parse：解析分享、过滤视频/大文件、去重入库。
- 启动时自动 init_db 建表。

### Phase 3（转存流程）
- 新增 VirtualMedia 字段：physical_path / is_archived / task_status / task_id。
- 新增 /api/v1/media/{id}/provision：入队 Redis（queue:transfer）。
- worker 完成队列消费、更新 DB 状态、刷新 WebDAV 缓存（/cache/invalidate）。
- QuarkClient 已实现真实 API 调用与深度日志。
  - sharepage/token 获取 stoken
  - 文件目录查询/创建
  - share_save 真实转存

### 排查与修复记录（关键）
- 路由 404：router.include_router 放在文件末尾才会注册所有端点。
- 容器内路由为空：修正 main.py 使用聚合 router。
- share_save 404：修正 share_save 调用域名到 drive-h.quark.cn。
- create dir 401：为文件相关 API 加 pr/fr/uc_param_str 参数。


## 当前状态
? 路由已注册成功（容器内可见 /api/v1/share/parse 和 /api/v1/media/{id}/provision）。  
? /provision 返回 202 Accepted，入队成功。  
?? share_save 已加入可配置字段与多 payload 变体回退（QUARK_SHARE_SAVE_FID_FIELD），仍需验证不同分享的成功率。  


## 未完成 / 待推进
1) **转存稳定性验证**
   - 已支持 sharepage/save（fid_list + fid_token_list）优先，必要时再回退 share_save 的字段变体。
   - share_save 支持 fid_list / share_fid_token_list / fid_token_list 变体回退，可通过 QUARK_SHARE_SAVE_FID_FIELD 强制字段。
   - 仍需在真实分享上验证成功率；若失败，继续捕获真实请求参数与返回再适配。
   - share_save 出现 404 时会自动切换 host（可用 QUARK_SHARE_SAVE_BASE_URL/QUARK_SHARE_SAVE_BASE_URLS 指定优先 host 列表）。
   - 默认会尝试从配置里的 share_safe_host 作为候选（可用 QUARK_SHARE_SAVE_USE_SAFE_HOST=0 关闭）。
2) **目录结构与命名规范**
   - 目前默认 /QuarkMedia/Movies，未实现更复杂分类与重命名规则。
3) **任务状态追踪**
   - task_status 只在失败/成功更新，尚未做重试、死信队列或幂等处理。
4) **数据库迁移**
   - 新字段需要确保在生产库完成迁移（Alembic 或手动 SQL）。
5) **安全与审计**
   - QUARK_COOKIE 更新策略与失效检测还未完善。


## 当前问题与观察
- 401 require login [guest]：通常因缺少 pr/fr/uc_param_str 参数或 Cookie 失效。
- share_save 404：使用错误域名（需 drive-h.quark.cn）。
- compose 警告 “version is obsolete”：已在本地移除 version 字段，需同步到服务器。


## 开发/验证流程（建议执行顺序）
1) 同步项目目录到服务器（建议 rsync）。
2) 重建镜像：`docker compose build --no-cache core-backend`
3) 启动服务：`docker compose up -d core-backend worker`
4) 验证路由是否注册：
   - `docker compose exec -T core-backend sh -lc "PYTHONPATH=/app python - <<'PY' ..."`
5) 调用 provision：
   - `curl -i -X POST http://localhost:8000/api/v1/media/1/provision`
6) 查看 worker 日志：
   - `docker compose logs -f worker`


## 可用测试脚本
- `scripts/test_provision.sh`：检查路由、OpenAPI、入队与队列状态。
- `scripts/test_quark_api.sh`：在 worker 内直接测试 stoken、目录创建、share_save。
- `scripts/test_deploy.sh`：部署后端到 WebDAV 的全链路冒烟测试（支持日志输出与可选 share_save 验证）。
- `scripts/pipeline_test.sh`：流水线部署测试脚本（自动记录日志，支持分享解析/入队/转存的可选验证）。


## 流水线测试流程（服务器）
1) 进入项目目录，确认 `.env` 格式正确且 `QUARK_COOKIE` 有值。
2) 运行流水线脚本（默认 build + up + 健康检查 + 日志汇总）。
3) 需要时追加分享解析（`PARSE_SHARE_URL`）与转存验证（`RUN_QUARK_API_TEST=1`）。
4) 将 `data/logs/pipeline_test.latest.log` 发回分析。
   - 脚本默认会脱敏 cookie / stoken（`REDACT_LOGS=1`），如需原始日志可设为 `0`。

**示例：**
- 基础冒烟：
  - `./scripts/pipeline_test.sh`
- 带分享解析：
  - `PARSE_SHARE_URL="https://pan.quark.cn/s/xxxx" PARSE_PASSCODE="abcd" ./scripts/pipeline_test.sh`
- 带转存验证（通过媒体 ID）：
  - `MEDIA_ID=1 RUN_QUARK_API_TEST=1 ./scripts/pipeline_test.sh`


## 下一步建议
1) 先保证 share_save 成功率（必要时调整 payload）。
2) 实现“重命名/分类目录”策略。
3) 增加任务重试与失败告警。
4) 完善 API 文档与部署脚本。

